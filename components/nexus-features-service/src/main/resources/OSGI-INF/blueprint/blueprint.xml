<?xml version="1.0" encoding="UTF-8"?>
<!--

    Sonatype Nexus (TM) Open Source Version
    Copyright (c) 2007-2014 Sonatype, Inc.
    All rights reserved. Includes the third-party code listed at http://links.sonatype.com/products/nexus/oss/attributions.

    This program and the accompanying materials are made available under the terms of the Eclipse Public License Version 1.0,
    which accompanies this distribution and is available at http://www.eclipse.org/legal/epl-v10.html.

    Sonatype Nexus (TM) Professional Version is available from Sonatype, Inc. "Sonatype" and "Sonatype Nexus" are trademarks
    of Sonatype, Inc. Apache Maven is a trademark of the Apache Software Foundation. M2eclipse is a trademark of the
    Eclipse Foundation. All other trademarks are the property of their respective owners.

-->
<blueprint
        xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
        xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
        http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.0.0 http://aries.apache.org/schemas/blueprint-ext/blueprint-ext.xsd">

    <ext:property-placeholder placeholder-prefix="$(" placeholder-suffix=")"/>

    <ext:property-placeholder placeholder-prefix="$[" placeholder-suffix="]" ignore-missing-locations="true">
        <ext:default-properties>
            <ext:property name="featuresRepositories" value=""/>
            <ext:property name="featuresBoot" value=""/>
            <ext:property name="resolverTimeout" value="5000"/>
            <ext:property name="respectStartLvlDuringFeatureStartup" value="true"/>
            <ext:property name="respectStartLvlDuringFeatureUninstall" value="true"/>
            <ext:property name="featuresBootAsynchronous" value="false"/>
            <ext:property name="overrides" value="file:$(karaf.etc)/overrides.properties"/>
        </ext:default-properties>
        <ext:location>file:$(karaf.etc)/org.apache.karaf.features.cfg</ext:location>
    </ext:property-placeholder>

    <reference-list id="featuresListeners" interface="org.apache.karaf.features.FeaturesListener"
                    availability="optional">

    <reference-listener ref="featuresService"
                            bind-method="registerListener"
                            unbind-method="unregisterListener"/>
    </reference-list>

    <reference id="configAdmin" interface="org.osgi.service.cm.ConfigurationAdmin"/>

    <reference id="mvnUrlHandler" interface="org.osgi.service.url.URLStreamHandlerService"
               filter="(url.handler.protocol=mvn)"/>

    <reference id="regionsPersistence" availability="optional"
               interface="org.apache.karaf.region.persist.RegionsPersistence"/>

    <bean id="bundleManager" class="org.sonatype.nexus.features.internal.ReferenceBundleManager">
        <argument ref="blueprintBundleContext"/>
        <argument ref="regionsPersistence"/>
    </bean>
    <bean id="configInstaller" class="org.apache.karaf.features.internal.FeatureConfigInstaller">
        <argument ref="configAdmin"/>
    </bean>
    <bean id="featuresService" class="org.apache.karaf.features.internal.FeaturesServiceImpl" init-method="start"
          destroy-method="stop">
        <argument ref="bundleManager"/>
        <argument ref="configInstaller"/>
        <property name="urls" value="$[featuresRepositories]"/>
        <property name="respectStartLvlDuringFeatureStartup" value="$[respectStartLvlDuringFeatureStartup]"/>
        <property name="respectStartLvlDuringFeatureUninstall" value="$[respectStartLvlDuringFeatureUninstall]"/>
        <property name="resolverTimeout" value="$[resolverTimeout]"/>
        <property name="overrides" value="$[overrides]"/>
    </bean>

    <bean id="bootFeaturesInstaller" class="org.apache.karaf.features.internal.BootFeaturesInstaller"
          init-method="start">
        <argument ref="blueprintBundleContext"/>
        <argument ref="featuresService"/>
        <argument value="$[featuresBoot]"/>
        <argument value="$[featuresBootAsynchronous]"/>
    </bean>

    <bean id="featuresServiceMBean" class="org.apache.karaf.features.management.internal.FeaturesServiceMBeanImpl">
        <property name="bundleContext" ref="blueprintBundleContext"/>
        <property name="featuresService" ref="featuresService"/>
    </bean>

    <service ref="featuresService" interface="org.apache.karaf.features.FeaturesService"/>

    <service ref="featuresServiceMBean" auto-export="interfaces">
        <service-properties>
            <entry key="jmx.objectname" value="org.apache.karaf:type=feature,name=$(karaf.name)"/>
        </service-properties>
    </service>

</blueprint>
